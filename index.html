<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spot The Slip ‚Äî Trainer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  /* ---------- Page shell / McKinsey style ---------- */
  :root{
    --mc-blue: #003A70;
    --mc-deep: #001A30;
    --card-border: #d2d6da;
  }
  html,body{height:100%;margin:0;}
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(180deg, #2550FF 0%, #001A30 100%) !important;
    background-attachment: fixed;
    color: white;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:36px 16px;
    box-sizing:border-box;
  }

  /* Container */
  .container {
    width: 960px;
    max-width: calc(100% - 40px);
  }

  /* Title */
  .site-title {
    text-align:center;
    margin-bottom:18px;
  }
  .site-title h1{
    margin:0;
    font-size:32px;
    font-weight:600;
    color:#fff;
  }
  .site-title p{
    margin:6px 0 0 0;
    color: rgba(255,255,255,0.88);
    font-weight:300;
  }

  /* Card */
  .card {
    background: white;
    color: var(--mc-blue);
    border-radius:10px;
    padding:26px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.24);
    border: 1px solid var(--card-border);
    box-sizing:border-box;
  }

  /* Instructions content */
  #instructionsPage .card { max-width:760px; margin: 0 auto; }
  #instructionsList { font-size:16px; line-height:1.6; color:#12324a; }

  /* Game area */
  #gameArea {
    width: 100%;
    max-width: 900px;
  }

  .topbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
    font-size:15px;
    color: #002B49;
  }

  /* Canvas */
  #slideCanvas {
    display:block;
    width:100%;
    max-width:800px;
    height:auto;
    border-radius:6px;
    border: 1px solid #ccd2d8;
    background: #fff;
    box-sizing: border-box;
    margin: 0 auto 14px auto;
  }

  /* Controls */
  .controls { text-align:center; margin-top:8px; }
  .controls button {
    padding: 10px 18px;
    background: #003A70;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
    margin-right: 10px;
    transition: background 0.2s ease;
}

button:hover {
    background: #004b91;
}
  .controls button.secondary {
    background:#7b8790;
  }

.hero-btn {
    padding: 14px 32px;
    font-size: 20px;
    font-weight: 500;
    border-radius: 8px;
    background: #0077b8; /* bright McKinsey teal-blue */
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.25s ease, transform 0.15s ease;
    font-family: "Helvetica Neue", Arial, sans-serif;
}

.hero-btn:hover {
    background: #0093dd; /* lighter hover blue */
    transform: translateY(-2px);
}

  /* Feedback */
  #feedback { text-align:center; color:#004b91; min-height:20px; margin-top:8px; }

  /* Summary page */
  #summaryPage .card { max-width:840px; margin: 0 auto; }
  .slide-summary { margin-bottom:12px; border-radius:8px; padding:14px; background:#f7fbff; color:var(--mc-blue); }
  .slide-summary b { display:block; margin-bottom:8px; }

  /* Responsive tweaks */
  @media (max-width:700px){
    .topbar { font-size:14px; }
    .controls button { width:48%; box-sizing:border-box; }
  }
</style>
</head>

<body>
  <div class="container">

    <div class="site-title">
      <h1>Spot the Slip</h1>
      <p>Page-making accuracy trainer ‚Äî find formatting & content errors</p>
    </div>

    <!-- ========== INSTRUCTIONS PAGE ========== -->
    <div id="instructionsPage">
      <div class="card" role="region" aria-labelledby="instructionsTitle">
        <h2 id="instructionsTitle" style="margin:0 0 10px 0; color:var(--mc-deep)">How the game works</h2>

        <div id="instructionsList">
          <p><strong>Objective:</strong> Identify page-making errors quickly and accurately.</p>

          <ul>
            <li>Each slide is shown for <strong>15 seconds</strong>.</li>
            <li>Total session time: <strong>60 seconds</strong>.</li>
            <li>Click each part of the page that you believe is an error.</li>
            <li><strong>Correct click:</strong> +100 points. <strong>Wrong click:</strong> -50 points.</li>
            <li>At the end you‚Äôll get a slide-by-slide summary with human-readable feedback.</li>
          </ul>

          <p><strong>Common things to check:</strong> alignment, footnotes/sources, inconsistent fonts/sizes, incorrect numbers, non-standard formatting.</p>
        </div>

        <div style="text-align:center; margin-top:18px;">
	<button id="startGameBtn" class="hero-btn" style="margin-top:40px;">
    	Start Game
	</button>
        </div>
      </div>
    </div>

    <!-- ========== GAME PAGE ========== -->
    <div id="gamePage" style="display:none;">
      <div id="gameArea" class="card" role="main">
        <div class="topbar">
          <div><b id="masterTimer">Time left: 60s</b> | <b id="pageTimer">Page time: 15s</b></div>
          <div>Score: <b id="score">0</b></div>
        </div>

        <!-- Canvas sized to 800x450 original slide area; we'll draw image scaled -->
        <canvas id="slideCanvas" width="800" height="450"></canvas>

        <div class="controls" style="margin-top:6px;">
          <button id="doneBtn" class="secondary">Done (Next)</button>
          <button id="endEarlyBtn">End Game</button>
        </div>

        <div id="feedback" aria-live="polite"></div>
      </div>
    </div>

    <!-- ========== SUMMARY PAGE ========== -->
    <div id="summaryPage" style="display:none;">
      <div class="card">
        <h2 style="margin-top:0; color:var(--mc-deep)">Game Summary</h2>
        <div id="finalScoreBox" style="font-size:18px; margin-bottom:14px;"></div>
        <div id="perSlideSummary"></div>

        <div style="text-align:center; margin-top:18px;">
          <button id="playAgainBtn" class="hero-btn">
	    Play Again
	</button>
        </div>
      </div>
    </div>

  </div>

<script>
/* ---------------- CONFIG ---------------- */
const MASTER_LIMIT = 60;
const PAGE_LIMIT = 15;

// NOTE: Using .PNG references intentionally (as requested)
const slides = [
  { id: "slide_1", imageSrc: "slides/slide_1.PNG", metaSrc: "metadata/slide_1.json", meta: null },
  { id: "slide_2", imageSrc: "slides/slide_2.PNG", metaSrc: "metadata/slide_2.json", meta: null },
  { id: "slide_3", imageSrc: "slides/slide_3.PNG", metaSrc: "metadata/slide_3.json", meta: null },
  { id: "slide_4", imageSrc: "slides/slide_4.PNG", metaSrc: "metadata/slide_4.json", meta: null }
];

/* ---------------- STATE ---------------- */
let masterTimer = MASTER_LIMIT;
let pageTimer = PAGE_LIMIT;
let masterInterval = null;
let pageInterval = null;
let currentIndex = 0;
let score = 0;
let currentClicked = [];
let currentIncorrect = [];
let sessionLog = [];

/* ---------------- ELEMENTS ---------------- */
const instructionsPage = document.getElementById("instructionsPage");
const gamePage = document.getElementById("gamePage");
const summaryPage = document.getElementById("summaryPage");

const startGameBtn = document.getElementById("startGameBtn");
const doneBtn = document.getElementById("doneBtn");
const endEarlyBtn = document.getElementById("endEarlyBtn");
const playAgainBtn = document.getElementById("playAgainBtn");

const masterEl = document.getElementById("masterTimer");
const pageEl = document.getElementById("pageTimer");
const scoreEl = document.getElementById("score");
const feedbackEl = document.getElementById("feedback");

const canvas = document.getElementById("slideCanvas");
const ctx = canvas.getContext("2d");

/* ---------------- UI: page switching ---------------- */
function showPage(page) {
  instructionsPage.style.display = "none";
  gamePage.style.display = "none";
  summaryPage.style.display = "none";

  if (page === "instructions") instructionsPage.style.display = "block";
  if (page === "game") gamePage.style.display = "block";
  if (page === "summary") summaryPage.style.display = "block";
}

/* ---------------- Start button ---------------- */
startGameBtn.addEventListener('click', () => {
  showPage("game");
  startGame();
});

/* ---------------- Canvas click handling and scaling ---------------- */
/* We assume slide metadata contains width/height fields (1280x720). Canvas is 800x450.
   Convert click coords to slide-space for detection, and convert boxes back to canvas-space for drawing. */

canvas.addEventListener('click', (ev) => {
  if (masterTimer <= 0) return;

  const rect = canvas.getBoundingClientRect();
  const slide = slides[currentIndex];
  const meta = slide.meta || {};
  const slideW = meta.width || 1280;
  const slideH = meta.height || 720;

  // canvas -> slide space
  const scaleToSlideX = slideW / canvas.width;
  const scaleToSlideY = slideH / canvas.height;
  const xSlide = (ev.clientX - rect.left) * scaleToSlideX;
  const ySlide = (ev.clientY - rect.top) * scaleToSlideY;

  const hit = (meta.errors || []).find(err => {
    const [bx, by, bw, bh] = err.bbox;
    return xSlide >= bx && xSlide <= bx + bw && ySlide >= by && ySlide <= by + bh;
  });

  if (hit) {
    if (!currentClicked.includes(hit.id)) {
      currentClicked.push(hit.id);
      score += 100;
      feedbackEl.textContent = "Correct: " + hit.label;
      drawTempBoxFromSlideCoords(meta, hit.bbox[0], hit.bbox[1], hit.bbox[2], hit.bbox[3], "rgba(0,180,0,0.95)");
    } else {
      feedbackEl.textContent = "Already found: " + hit.label;
    }
  } else {
    currentIncorrect.push({x: xSlide, y: ySlide});
    score -= 50;
    if (score < 0) score = 0;
    feedbackEl.textContent = "Incorrect click (-50)";
    // draw small red dot at click (converted back to canvas coords)
    const scaleToCanvasX = canvas.width / slideW;
    const scaleToCanvasY = canvas.height / slideH;
    const cx = xSlide * scaleToCanvasX;
    const cy = ySlide * scaleToCanvasY;
    const size = 18;
    ctx.fillStyle = "rgba(200,0,0,0.95)";
    ctx.fillRect(cx - size/2, cy - size/2, size, size);
    setTimeout(() => { redrawCurrentSlide(); }, 700);
  }
  scoreEl.textContent = score;
});

/* ---------------- Temporary highlight drawing (converts slide-space box -> canvas-space) ---------------- */
function drawTempBoxFromSlideCoords(slideMeta, bx, by, bw, bh, color, timeout = 700) {
  const slideW = (slideMeta && slideMeta.width) ? slideMeta.width : 1280;
  const slideH = (slideMeta && slideMeta.height) ? slideMeta.height : 720;
  const scaleX = canvas.width / slideW;
  const scaleY = canvas.height / slideH;

  const cx = bx * scaleX;
  const cy = by * scaleY;
  const cw = bw * scaleX;
  const ch = bh * scaleY;

  ctx.save();
  ctx.lineWidth = 3;
  ctx.strokeStyle = color;
  ctx.strokeRect(cx, cy, cw, ch);
  ctx.restore();

  setTimeout(() => { redrawCurrentSlide(); }, timeout);
}

/* ---------------- Utility: redraw current slide image ---------------- */
function redrawCurrentSlide() {
  const slide = slides[currentIndex];
  if (!slide) {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  const img = new Image();
  img.onload = function(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };
  img.onerror = function(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#eee";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  };
  img.src = slide.imageSrc;
}

/* ---------------- LOAD SLIDE ---------------- */
async function loadSlide(i) {
  const slide = slides[i];
  if (!slide) return;

  try {
    const res = await fetch(slide.metaSrc);
    if (!res.ok) {
      throw new Error("metadata not found: " + slide.metaSrc);
    }
    const meta = await res.json();
    slide.meta = meta;
  } catch (err) {
    console.error("Error loading metadata:", err);
    slide.meta = { width:1280, height:720, errors: [] };
  }

  // reset state for that page
  currentClicked = [];
  currentIncorrect = [];
  pageTimer = PAGE_LIMIT;
  pageEl.textContent = `Page time: ${pageTimer}s`;
  feedbackEl.textContent = "";

  // draw image (scaled to canvas)
  redrawCurrentSlide();

  // start per-page timer
  if (pageInterval) clearInterval(pageInterval);
  pageInterval = setInterval(() => {
    pageTimer--;
    pageEl.textContent = `Page time: ${pageTimer}s`;
    if (pageTimer <= 0) {
      recordAndNext();
    }
  }, 1000);
}

/* ---------------- GAME START / TIMERS ---------------- */
function startGame() {
  // reset session state
  masterTimer = MASTER_LIMIT;
  pageTimer = PAGE_LIMIT;
  currentIndex = 0;
  score = 0;
  currentClicked = [];
  currentIncorrect = [];
  sessionLog = [];

  scoreEl.textContent = score;
  masterEl.textContent = `Time left: ${masterTimer}s`;
  pageEl.textContent = `Page time: ${pageTimer}s`;

  // master timer
  if (masterInterval) clearInterval(masterInterval);
  masterInterval = setInterval(() => {
    masterTimer--;
    masterEl.textContent = `Time left: ${masterTimer}s`;
    if (masterTimer <= 0) {
      endGame();
    }
  }, 1000);

  loadSlide(0);
}

/* ---------------- DONE / NEXT ---------------- */
function recordAndNext() {
  if (pageInterval) clearInterval(pageInterval);

  const slide = slides[currentIndex];
  const meta = slide.meta || {};
  const allErrorIds = (meta.errors || []).map(e => e.id);
  const missed = allErrorIds.filter(id => !currentClicked.includes(id));

  sessionLog.push({ slideId: slide.id, found: currentClicked.slice(), missed: missed.slice() });

  currentIndex++;
  if (currentIndex >= slides.length || masterTimer <= 0) {
    endGame();
  } else {
    loadSlide(currentIndex);
  }
}

/* done button / end early button */
doneBtn.addEventListener('click', recordAndNext);
endEarlyBtn.addEventListener('click', () => { endGame(); });

/* PLAY AGAIN BUTTON ‚Äî INSERT THIS */

playAgainBtn.addEventListener("click", () => {
    location.reload();
});

/*--------------------LEVELS-------------------*/

const LEVELS = [
    {
        min: 0, max: 24,
        title: "The Alignment Amnesiac",
        icon: "üòµ‚Äçüí´",
        color: "#cc2936",
        description: "You‚Äôre missing the basics ‚Äî alignment, margins, spacing. A little practice will go a long way!"
    },
    {
        min: 25, max: 49,
        title: "Margin Marginally Aware",
        icon: "ü§∑‚Äç‚ôÇÔ∏è",
        color: "#e76f51",
        description: "You‚Äôre noticing some issues, but many fundamentals are slipping by unnoticed."
    },
    {
        min: 50, max: 74,
        title: "Consistency Crusader",
        icon: "üõ°Ô∏è",
        color: "#2a9d8f",
        description: "You‚Äôre spotting structural inconsistencies ‚Äî solid foundation, keep sharpening!"
    },
    {
        min: 75, max: 89,
        title: "Slide Sleuth",
        icon: "üïµÔ∏è‚Äç‚ôÄÔ∏è",
        color: "#0077b6",
        description: "Strong eye for detail ‚Äî you can catch the majority of issues with confidence."
    },
    {
        min: 90, max: 99,
        title: "Deck Demigod",
        icon: "‚ö°",
        color: "#7209b7",
        description: "Elite-level instincts. Errors rarely escape your gaze."
    },
    {
        min: 100, max: 100,
        title: "Senior Partner of Slides",
        icon: "üåü",
        color: "#f4a261",
        description: "Masterful. You don‚Äôt make slides ‚Äî you *orchestrate* them."
    }
];

function getLevelInfo(percent) {
    return LEVELS.find(level => percent >= level.min && percent <= level.max);
}

/*-----------------CONFETTI---------------------------*/

function launchEmojiConfetti(emojiArray, count = 80) {
    for (let i = 0; i < count; i++) {

        const span = document.createElement("span");
        span.textContent = emojiArray[Math.floor(Math.random() * emojiArray.length)];

        // random size + depth effect
        const size = Math.random() * 18 + 16;
        const depthFactor = size / 34; // bigger emojis fall slower
        const rotateDir = Math.random() > 0.5 ? 1 : -1;

        span.style.position = "fixed";
        span.style.zIndex = 9999;
        span.style.fontSize = size + "px";
        span.style.left = (Math.random() * window.innerWidth) + "px";
        span.style.top = (-50 - Math.random() * 200) + "px";
        span.style.opacity = 1;
        span.style.pointerEvents = "none";
        span.style.transition = `
            transform ${2.5 + Math.random() * 2}s cubic-bezier(.25,.46,.45,1),
            opacity 3.5s ease-out
        `;

        document.body.appendChild(span);

        // RANDOMIZED DRIFT + FALL
        const driftX = (Math.random() - 0.5) * 600; // left or right drift
        const fallY = window.innerHeight + 500; // full fall

        // randomized rotation
        const rotate = rotateDir * (Math.random() * 720 + 360);

        // stagger each drop slightly
        setTimeout(() => {
            span.style.transform = `translate(${driftX}px, ${fallY}px) rotate(${rotate}deg)`;
            span.style.opacity = 0;
        }, i * 30 + Math.random() * 120);

        // cleanup
        setTimeout(() => span.remove(), 5000);
    }
}


function triggerLevelConfetti(percent) {
    if (percent < 50) {
        // lower levels
        launchEmojiConfetti(["üòµ‚Äçüí´", "üò¨", "ü§Ø"], 70, 0.45);
    }
    else if (percent < 90) {
        // mid levels
        launchEmojiConfetti(["üëç", "üëè", "üëå"], 80, 0.35);
    }
    else {
        // senior partner levels ‚Üí real confetti look
        launchEmojiConfetti(["üéâ", "‚ú®", "üåü", "üéä"], 120, 0.30);
    }
}


/* ---------------- END GAME / SUMMARY ---------------- */
function endGame() {
  // stop timers
  if (masterInterval) { clearInterval(masterInterval); masterInterval = null; }
  if (pageInterval) { clearInterval(pageInterval); pageInterval = null; }

  // if current slide still active, save its state
  if (currentIndex < slides.length) {
    const slide = slides[currentIndex];
    const meta = slide.meta || {};
    const allErrorIds = (meta.errors || []).map(e => e.id);
    const missed = allErrorIds.filter(id => !currentClicked.includes(id));
    sessionLog.push({ slideId: slide.id, found: currentClicked.slice(), missed: missed.slice() });
  }

  // show summary page
  showPage("summary");

  // final score
  const finalScoreBox = document.getElementById("finalScoreBox");
  const totalErr = totalErrors();
const foundErr = totalFound();
const percent = totalErr === 0 ? 0 : Math.round((foundErr / totalErr) * 100);

triggerLevelConfetti(percent);

const lvl = getLevelInfo(percent);

finalScoreBox.innerHTML = `
    <div style="font-size:22px; margin-bottom:6px;">
        <strong>Final Score:</strong> ${score}
    </div>

    <div style="font-size:18px; margin-bottom:6px;">
        <strong>Accuracy:</strong> ${percent}%
    </div>

    <div style="margin-top:14px; font-size:24px; font-weight:600; color:${lvl.color};">
        ${lvl.icon} ${lvl.title}
    </div>

    <div style="font-size:15px; margin-top:8px; color:#002B49; line-height:1.45;">
        ${lvl.description}
    </div>
`;


  // per-slide breakdown
  const container = document.getElementById("perSlideSummary");
  container.innerHTML = "";
  sessionLog.forEach((sl, i) => {
    const slideMeta = slides.find(s => s.id === sl.slideId).meta || { errors: [] };

    const foundLabels = (sl.found || []).map(id => {
      const err = (slideMeta.errors || []).find(e => e.id === id);
      return err ? err.label : id;
    });

    const missedLabels = (sl.missed || []).map(id => {
      const err = (slideMeta.errors || []).find(e => e.id === id);
      return err ? err.label : id;
    });

    const html = document.createElement('div');
    html.className = "slide-summary";
    html.innerHTML = `
      <b>Slide ${i+1} (${sl.slideId})</b>
      <div style="margin-top:8px;"><strong>Found:</strong><br>
        ${ foundLabels.length ? foundLabels.map(l => "‚úîÔ∏è " + l).join("<br>") : "None" }
      </div>
      <div style="margin-top:8px;"><strong>Missed:</strong><br>
        ${ missedLabels.length ? missedLabels.map(l => "‚ùå " + l).join("<br>") : "None" }
      </div>
    `;
    container.appendChild(html);
  });
}

function totalErrors(){
  return slides.reduce((acc,s) => {
    const m = s.meta || {};
    return acc + ((m.errors && m.errors.length) || 0);
  }, 0);
}
function totalFound(){
  return sessionLog.reduce((acc,sl) => acc + ((sl.found && sl.found.length) || 0), 0);
}

/* ---------------- Play again ---------------- */
playAgainBtn.addEventListener('click', () => {
  // reload the page to reset everything simply
  location.reload();
});

/* ---------------- On load: show instructions ---------------- */
showPage("instructions");

/* ---------------- Helpful dev logs (safe to keep) ---------------- */
console.log("Spot the Slip ‚Äî initialized. Slides:", slides.length);
</script>
</body>
</html>
